layout: photo
title: DIGGER业务监控
tags:
- 原创
- 监控预警
- Elasticsearch
photos:
  - http://siye1982.github.io/img/blog/digger/digger.png
date: 2016-12-24 10:12:31
categories: 监控预警
---

# 系统定位
业务监控, 主要侧重对业务数据的实时监控, 以日志的方式进行数据收集, 对业务数据进行深入的统计分析, 帮助业务方发现问题, 定位问题根源. 这其中数据分为: 业务自身输出的业务日志(比如: 提单, 推单, 接单等状态数据), 业务异常, 报警事件等. 
<!--more-->
发现问题原因之后我们需要解决问题, 最终目的是可以基于我们分析的结果给运维动作做出决策, 以达到自动化运维的目的. 另外, 明确系统用户将有助于把控业务监控产品的设计方向, 业务监控系统的第一用户是RD, 不是老板, 我们是要帮助RD更快的发现问题, 预知问题, 提供标准化解决问题的建议.

# 概要设计
## 数据模型
![数据模型](http://siye1982.github.io/img/blog/digger/data_model.png)

* BusinessLog: 需要在业务中进行埋点, 业务主动以固定的格式通过日志输出的方式上报数据, 然后Digger会实时汇总分析, 通过各种曲线展示业务状态的走势.
* EventLog: 随着各个业务系统的成长, 每天会有各种事件产生. 当某些系统有问题时, 通常会产生各种报警事件. 另外, 系统大部分的故障都会和发布新版本,配置变更有关系, 记录这些事件并加以分析, 可以帮助我们快速定位问题的根源.
* ExceptionLog: 当业务代码运行时没有达到预期将会抛出运行时异常, 对这些异常进行收集并设置分类器, 将会帮助我们更细粒度的定位到问题的起因.


## 数据收集流向
![数据收集流向](http://siye1982.github.io/img/blog/digger/digger_data_flow.png)

1. 业务服务中产生的数据主要包含两大类:
	(1) 不需要业务服务埋点, 通用底层监控框架自动收集的数据. 这其中包括: 系统指标,性能指标,服务异常等.
	(2) 需要业务服务埋点,自己上报业务状态日志. 这部分数据会直接通过日志的方式流入日志收集通道.
2. 底层监控系统主要是类似zabbix的系统层级的监控系统, 我们主要使用的是Cat,Falcon等开源系统, 这些系统本身可以配置各种报警规则, 并可以对异常日志进行归类统计. 因为各个系统产生的事件发送方式繁多, 我们如果各个去适配,后续的维护成本会非常高.这时我们将考虑推动事件接收通道的统一.
3. 公司层面所有的事件都会通过IM的方式推动给各个团队, 这时我们申请开通了Digger系统自己的IM账号, 并推动各个事件产生方统一给Digger的IM账号发送事件信息. 
4. Digger系统会部署自己的数据收集器(Digger-collector), 用来收集IM通道中的各种事件,以及其他特殊原因产生的监控数据.
5. 不管是业务埋点发送的业务状态日志, 还是Digger-collector收集的事件等信息, 最终都会统一发送到统一的日志通道中.
6. 我们最终使用Elasticsearch让监控日志落地, 利用Elasticsearch做各种复杂的近实时的统计分析.
7. Elasticsearch中会存储聚合分析后的结果数据, 最终通过Digger-admin读取展示监控图表给用户.
 

## 系统结构
![系统结构](http://siye1982.github.io/img/blog/digger/digger_structure.png)

现有报警数据种类繁多, 每天产生的数量庞大, 这其中有相当一部分数据是因为阈值设定不合理而引起的误报而是会降低报警的实用性, 我们需要实时收集这些报警事件并做二次统计分析, 报警事件由多种方式发出, 所以需要有独立的collector组件负责收集这些事件, 后续其他类型业务数据的收集也可以通过collector完成.由于异常数据, 业务数据, 事件数据都有各自的结构, 为了简化日志格式化处理过程, 我们需要封装一个client来做这个事情, 尽量使日志格式化的动作对业务方透明.
# 预测报警

# 碰到的问题




<div style="margin-top: 15px; font-size: 11px;color: #cc0000;"><p align="center"><strong>（转载本站文章请注明作者和出处 <a href="http://siye1982.github.io">Panda</a>）</strong></p></div>

